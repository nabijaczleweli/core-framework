export default class preloader{static getTimestamp(){return (window.performance.now||window.performance.webkitNow||Date.now).call(window.performance);}constructor(onCompl, ...images){this.onComplete=onCompl;this.config={cache: true,};this.time={start: 0,end: 0,};this.total=0;this.images=[];this._queue=[];if(onCompl && images && images.length){this.enqueue(...images);this.preload();}}enqueue(...elements){this._queue.splice(0, 0, ...elements.map(elem=> ((typeof elem==='string') ?{source: elem}: elem)));return this;}_finish(index, image){--this.total;(this.images.find(img=> img.index==index)||{}).size={width: image.width,height: image.heigth,};if(!this.total){this.time.end=preloader.getTimestamp();this.onComplete({time: Math.round(this.time.end-this.time.start),images: this.images,});}}preload(cbk){this.onComplete=cbk||this.onComplete;this.time.start=preloader.getTimestamp();this.total=this._queue.length;this._queue.forEach(queued=>{let index=this.images.length;let image=new Image();this.images.push({index,image,size:{width: 0,height: 0,},});image.onload=image.onerror=image.onabort=(()=> this._finish(index, image));image.src=queued.source+(this.config.cache ? '' : ('?__preloader_cache_invalidator='+preloader.getTimestamp()));});this._queue.length=0;}preloadCSSImages(cbk){this.enqueue(...this._getCSSImages()).preload(cbk);}_getCSSRules(){const allrules=[];const collectorRaw=rules=>{Array.from(rules).forEach(rule=>{allrules.push({rule,selectorText: rule.selectorText||null,declaration: rule.cssText||rule.style.cssText,});collector(rule.styleSheet||{});});};const collector=sheet=> collectorRaw(sheet.rules||sheet.cssRules||[]);Array.from(document.styleSheets).forEach(sheet=>{collector(sheet);(sheet.imports||[]).forEach(collector);});return allrules;}_getCSSImages(){return this._getCSSRules().reduce((prev, cur)=> prev.concat(cur.declaration.match(/[^(|'"]+.(jpg|jpeg|gif|png|apng|bmp)\)?/ig)), []);}}